{% load static %}
<div id="modal-edicao"
    class="modal-edicao hidden d-flex justify-content-center align-items-center bg-dark bg-opacity-25 fixed-top vh-100">
    <div class="modal-content rounded-4 shadow-sm p-3 d-flex flex-row gap-3"
        style="max-width: 60vw; width: 100%; height: 80vh; overflow: hidden; background-color: #f8f9fa;" >

        <img src="{% static 'hospital/img/detalhe/X.svg' %}" alt="fechar"
         class="modal-icon-top-right" onclick="fecharmodal()" width="3" height="3">

        <!-- Formulário -->
        <div id="modal-form" class="flex-grow-1 overflow-auto p-1" style="min-width: 50%;">
            <!-- Cabeçalho -->
            <div class="mb-3 p-3 rounded card-plantao">
                <h2 class="mb-1 title-plantao" id="edicao-data">week, DD/MM/YYYY</h2>
                <hr>
                <p class="mb-2 header-text" ><strong>Gestor: </strong><span id="edicao-manager">unknown</span></p>
                <p class="header-text"><strong>Setor: </strong><span  id="edicao-department">unknown</span></p>
            </div>

            
            <div class="mb-3 p-3 card-plantao">
                <!-- Hora de início -->
                <div class="mb-3">
                <label class="form-label d-block">
                    <div class="d-flex align-items-center gap-2 mb-2">
                    <img class="hours-icon" src="{% static 'hospital/img/detalhe/time.svg'%}" alt="">
                    <span class="hours-label">Hora de início:</span>
                    </div>
                    <input  id="edicao-start"
                            type="text"
                            class="form-control field-hours"
                            value="00:00"
                            data-clocklet="format: HH:mm; alignment: center; placement: bottom;">
                            
                </label>
                </div>

                <!-- Hora de saída -->
                <div class="mb-3">
                <label class="form-label d-block">
                    <div class="d-flex align-items-center gap-2 mb-2">
                    <img class="hours-icon" src="{% static 'hospital/img/detalhe/time.svg'%}" alt="">
                    <span class="hours-label">Hora de saída:</span>
                    </div>
                    <input  id="edicao-end"
                            type="text"
                            class="form-control field-hours"
                            value="00:00"
                            data-clocklet="format: HH:mm; alignment: center; placement: bottom;">
                </label>
                </div>

                <div class="position-relative">
                    <textarea id="edicao-descricao" maxlength="1000"
                        placeholder="Deseja adicionar uma descrição ao plantão?"
                        class="form-control form-control-sm field-desc pe-5" rows="4"
                        style=""
                        oninput="atualizarContador(this)"
                        ></textarea>

                    <small id="contador-desc" class="text-muted position-absolute" style="bottom: 4px; right: 8px; pointer-events: none;">
                        Max 1000
                    </small>
                </div>
            </div>

            <!-- Médicos alocados -->
            <div class="mb-3 p-3 rounded card-plantao">
                <h4 class="title-alocados mb-1">Médicos alocados</h4>
                <hr>
                <div class="medicos-alocados" id="medicos-alocados">
                    <!-- Aqui o JS insere a UL com os médicos -->
                    <p class="text-muted p-5 mb-3 mt-3">Nenhum médico alocado ainda.</p>
                </div>
            </div>

            <!-- Botões -->
        </div>
<div class="d-flex flex-column" style="height: 100%; width: 35%;position: relative;">
    <!-- Container da Lista e Filtros -->
    <div id="modal-med" class="d-flex flex-column flex-grow-1 overflow-hidden rounded p-3 card-plantao">
        
        <!-- Filtros -->
<div class="d-flex gap-2 mb-3">
  <!-- Dropdown de Ordenar -->
  <div class="dropdown-custom">
    <button class="dropdown-toggle" id="btnOrdenar">
        <img src="{% static "hospital/img/CriarPlantao/seta.svg" %}" alt="" class="caret-icon me-1" width="15px" height="15px">
        Ordenar
        
    </button>
    <ul class="dropdown-menu" id="menuOrdenar">
      <li><label><input type="checkbox" name="ordenar" value="alfabetica"> Ordem alfabética</label></li>
      <li><label><input type="checkbox" name="ordenar" value="livre"> Mais livre </label></li>
      <li><label><input type="checkbox" name="ordenar" value="ocupado"> Mais ocupado</label></li>
    </ul>
  </div>

  <!-- Dropdown de Filtrar -->
  <div class="dropdown-custom">
    <button class="dropdown-toggle" id="btnFiltrar">
        <img src="{% static "hospital/img/CriarPlantao/seta.svg" %}" alt="" class="caret-icon me-1" width="15px" height="15px">
        Filtrar
    </button>
    <ul class="dropdown-menu" id="menuFiltrar">
 <li><label><input type="checkbox" id="filtroLivre" name="filtro" value="livre"> Carga livre</label></li>
<li><label><input type="checkbox" id="filtroCheia" name="filtro" value="cheia"> Carga cheia</label></li>
    </ul>
  </div>
</div>

        <!-- Campo de busca -->
        <div class="input-wrapper position-relative mb-3">
            <img class="icon-lupa position-absolute" src="{% static 'hospital/img/CriarPlantao/lupa.svg' %}">
            <input id="srcbar" type="text" class="form-control srcbar" placeholder="Procurando por alguém?">
        </div>


        <div class="flex-grow-1 overflow-auto">
            <ul id="lista-medicos" class="list-unstyled"></ul>
        </div>
    </div>

    <!-- Botões fixos no fim -->
    <div class="mt-3 p-3">
        <div class="d-flex gap-2">
            <button id="bnt-delete-shift"class="button-excluir flex-fill" onclick="deletarPlantao()">
                Excluir
            </button>
            <button class="button-salvar flex-fill" onclick="salvarPlantao()">
                Salvar
            </button>
        </div>
    </div>
</div>
    </div>

</div>
<script>

const inputs = document.querySelectorAll('#edicao-start, #edicao-end');
const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;

function timeToMinutes(timeStr) {
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

function createErrorMessage() {
  // Verifica se já existe a mensagem para não criar duplicada
  let msg = document.getElementById('time-error-message');
  if (!msg) {
    msg = document.createElement('div');
    msg.id = 'time-error-message';
    msg.style.color = 'red';
    msg.style.marginBottom = '8px';
    msg.style.fontWeight = 'bold';
    msg.textContent = 'Horário inicial deve ser menor que o horário final.';
    // Insere antes do container dos inputs, ajuste o seletor conforme seu HTML
    const container = document.querySelector('#edicao-start').parentElement;
    container.insertBefore(msg, container.firstChild);
  }
  return msg;
}

function removeErrorMessage() {
  const msg = document.getElementById('time-error-message');
  if (msg) msg.remove();
}

function validateTimes() {
  const startInput = document.getElementById('edicao-start');
  const endInput = document.getElementById('edicao-end');

  const startVal = startInput.value.trim();
  const endVal = endInput.value.trim();

  if (!regex.test(startVal) || !regex.test(endVal)) {
    removeErrorMessage();
    return;
  }

  const startMinutes = timeToMinutes(startVal);
  const endMinutes = timeToMinutes(endVal);

  if (startMinutes >= endMinutes) {
    startInput.classList.add('is-invalid');
    endInput.classList.add('is-invalid');
    createErrorMessage();
  } else {
    startInput.classList.remove('is-invalid');
    endInput.classList.remove('is-invalid');
    removeErrorMessage();
  }
}

// Inicializa valor padrão se necessário e adiciona listeners
inputs.forEach(input => {
  if (!regex.test(input.value.trim())) {
    input.value = "00:00";
  }

  input.addEventListener('input', () => {
    const value = input.value.trim();

    if (!regex.test(value)) {
      input.classList.add('is-invalid');
    } else {
      input.classList.remove('is-invalid');
      validateTimes();
    }
  });

  input.addEventListener('blur', () => {
    const value = input.value.trim();

    if (!regex.test(value)) {
      input.value = "00:00";
      input.classList.remove('is-invalid');
    }
    validateTimes();
  });
});

</script>
<script src="{% static 'hospital/js/sort-and-filter-doctors.js' %}"></script>